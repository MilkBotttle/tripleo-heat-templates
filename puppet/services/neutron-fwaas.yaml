heat_template_version: pike

description: >
  Neutron FWaaS service configured with Puppet

parameters:
  ServiceData:
    default: {}
    description: Dictionary packing service data
    type: json
  ServiceNetMap:
    default: {}
    description: Mapping of service_name -> network name. Typically set
                 via parameter_defaults in the resource registry.  This
                 mapping overrides those in ServiceNetMapDefaults.
    type: json
  DefaultPasswords:
    default: {}
    type: json
  RoleName:
    default: ''
    description: Role name on which the service is applied
    type: string
  RoleParameters:
    default: {}
    description: Parameters specific to the role
    type: json
  EndpointMap:
    default: {}
    description: Mapping of service endpoint -> protocol. Typically set
                 via parameter_defaults in the resource registry.
    type: json
  NeutronFWaasEnabled:
    defualt: true
    type: boolean
  NeutronFWaasDriver:
    default: 'neutron_fwaas.services.firewall.drivers.linux.iptables_fwaas.IptablesFwaasDriver'
  NeutronFWaaSAgentVersioin:
    default: v1
    type: string
  NeutronServiceProviders:
    default: 'FIREWALL:Iptables:neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver:default'
    description: Global list of service providers used by neutron. This
                 list should be passed in to ensure all service
                 providers desired by the user are included. The
                 provided default value only set the provider for the LBaaSv2
                 subsystem.This is currently incompatible with enabling
                 octavia-api as one service or the other will break because the defaults are different.
    type: comma_delimited_list

resources:

  NeutronBase:
    type: ./neutron-base.yaml
    properties:
      ServiceData: {get_param: ServiceData}
      ServiceNetMap: {get_param: ServiceNetMap}
      DefaultPasswords: {get_param: DefaultPasswords}
      EndpointMap: {get_param: EndpointMap}
      RoleName: {get_param: RoleName}
      RoleParameters: {get_param: RoleParameters}

outputs:
  role_data:
    description: Role data for the Neutron VPNaaS role.
    value:
      service_name: neutron_vpnaas
      config_settings:
        map_merge:
          - get_attr: [NeutronBase, role_data, config_settings]
          - neutron::services::fwaas::enabled: {get_param: NeutronFWaasEnabled}
            neutron::services::fwaas::driver: {get_param: NeutronFWaasDriver}
            neutron::services::fwaas::agent_version: {get_param: NeutronFWaaSAgentVersioin}
      step_config: |
        include ::tripleo::profile::base::neutron::fwaas
      service_config_settings:
        neutron_api:
          neutron::server::service_providers: {get_param: NeutronServiceProviders}
        horizon:
          horizon::neutron_options:
            enable_firewall: True
